---
title: "Introdu√ß√£o √†s Ordena√ß√µes"
subtitle: "Simplificando Dados Complexos de Vegeta√ß√£o"
author: "Pedro Higuchi"
institute: "UDESC - Universidade do Estado de Santa Catarina"
date: today
format:
  revealjs:
    theme: default
    slide-number: true
    footer: "Descri√ß√£o e An√°lise da Vegeta√ß√£o"
    incremental: false
    transition: slide
editor: visual
execute:
  echo: true
  warning: false
  message: false
---

```{r setup}
#| include: false
# Configura√ß√µes globais
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)

# Carregar pacotes
library(vegan)
library(dplyr)
library(knitr)
```

## O que vamos aprender ?

**Ordena√ß√µes N√£o-Restritas (explora√ß√£o):**

-   PCA, DCA, NMDS, PCoA

**Ordena√ß√µes Restritas (teste de hip√≥teses):**

-   RDA e CCA

**An√°lises Avan√ßadas:**

-   Parti√ß√£o da vari√¢ncia
-   Testes multivariados (PERMANOVA, betadisper)

**Pr√°tica:** Dados reais da Floresta com Arauc√°ria

**Objetivo: Do b√°sico ao avan√ßado em an√°lise multivariada!** üìä‚Üíüìà

## O Problema

Imagine que voc√™ mediu:

-   50 parcelas de floresta

-   90 esp√©cies diferentes de √°rvores

-   10 vari√°veis de solo em cada parcela

**Pergunta: Como visualizar tudo isso em um gr√°fico?** ü§î

**Resposta: N√£o d√°! S√£o muitas dimens√µes...**

**Solu√ß√£o: ORDENA√á√ÉO = resumir em 2 ou 3 dimens√µes que voc√™ pode ver!**

## Analogia: √çndice de Vegeta√ß√£o (NDVI)

::::: columns
::: {.column width="50%"}
**Sensor multiespectral:**

-   üî¥ Vermelho (RED)
-   üåø Infravermelho (NIR)
-   üîµ Azul, üü¢ Verde
-   Outras bandas...

**‚Üí M√∫ltiplas dimens√µes**
:::

::: {.column width="50%"}
**√çndice NDVI:**

$$NDVI = \frac{NIR - RED}{NIR + RED}$$

-   √önico n√∫mero (-1 a +1)
-   Resume "sa√∫de vegetal"

**‚Üí 10+ bandas ‚Üí 1 √≠ndice**
:::
:::::

NDVI resume bandas espectrais \| PCA resume dados ambientais por exemplo

**10 Vari√°veis ambientais ‚Üí PC1 e PC2** üå≤

## O que descobrimos com ordena√ß√£o?

-   Parcelas parecidas ficam pr√≥ximas no gr√°fico

-   Parcelas diferentes ficam distantes

-   Gradientes ambientais (fertilidade, altitude, umidade)

-   Grupos naturais de parcelas ou esp√©cies

-   Fatores mais importantes que explicam as diferen√ßas

## Nossos Dados Exemplo

**Floresta Ombr√≥fila Mista (Floresta com Arauc√°ria)**

**Vegeta√ß√£o:**

-   50 parcelas
-   90 esp√©cies de √°rvores
-   2.837 indiv√≠duos
-   Esp√©cie principal: *Araucaria angustifolia*

**Ambiente:**

-   pH do solo
-   Nutrientes (P, K, Ca, Mg)
-   Mat√©ria org√¢nica
-   Altitude
-   Declividade

## Dois Tipos de Ordena√ß√£o

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 4
library(DiagrammeR)

grViz("
digraph tipos {
  graph [rankdir = LR, bgcolor = transparent]
  node [shape = box, style = filled, fontname = Arial, fontsize = 14]
  
  A [label = 'Seus dados', fillcolor = '#2C5F2D', fontcolor = white]
  B [label = 'N√ÉO-RESTRITA\n\nBusca padr√µes\nlivremente', fillcolor = 'lightblue']
  C [label = 'RESTRITA\n\nTesta se vari√°veis\nexplicam padr√µes', fillcolor = 'lightyellow']
  
  A -> B
  A -> C
}
")
```

**Hoje vamos focar em ordena√ß√£o N√ÉO-RESTRITA (explora√ß√£o inicial)**

## PCA - An√°lise de Componentes Principais

**Quando usar:**

-   Dados ambientais (solo, clima, topografia)
-   Gradientes curtos (\< 3 SD)
-   Poucos zeros na matriz de dados

**Ideia b√°sica: Encontra as dire√ß√µes de maior varia√ß√£o nos dados**

## O que s√£o Gradientes Curtos? üìè

**Gradiente \< 3 SD = Condi√ß√µes ambientais homog√™neas**

::::: columns
::: {.column width="50%"}
**EXEMPLO 1: Parcelas em encosta sul**

-   Condi√ß√µes similares
-   Varia√ß√£o pequena

```         
P1: pH 5.2, Ca 4.5, Alt 920m
P2: pH 5.5, Ca 5.1, Alt 935m
P3: pH 5.0, Ca 4.2, Alt 915m
```

‚úÖ pH: 5.0-5.5 (varia√ß√£o 0.5)

‚úÖ Ca: 4.2-5.1 (varia√ß√£o 0.9)

‚úÖ Altitude similar
:::

::: {.column width="50%"}
**EXEMPLO 2: Topo, enconsta e baixada**

-   Condi√ß√µes muito diferentes
-   Varia√ß√£o grande

```         
P1: pH 6.5, Ca 12.5, Alt 850m
P15: pH 5.5, Ca 5.2, Alt 950m
P30: pH 4.0, Ca 1.2, Alt 1100m
```

‚ùå pH: 4.0-6.5 (varia√ß√£o 2.5)

‚ùå Ca: 1.2-12.5 (varia√ß√£o 11.3)

‚ùå Altitude muito diferente
:::
:::::

## Entendendo o SD (Desvio Padr√£o)

**SD = Standard Deviation** - unidade que mede a **mudan√ßa nas condi√ß√µes ambientais**

**Interpreta√ß√£o pr√°tica com vari√°veis de solo:**

-   **\< 3 SD** = Condi√ß√µes variam pouco ‚Üí ambiente homog√™neo
-   **\> 4 SD** = Condi√ß√µes variam muito ‚Üí ambiente heterog√™neo

## Entendendo o SD (Desvio Padr√£o)

**Exemplo comparativo:**

```         
Gradiente CURTO (2.5 SD):
pH:       5.0 ‚Üí 5.5 ‚Üí 5.2 ‚Üí 5.3  (varia√ß√£o: 0.5 unidades)
C√°lcio:   4.2 ‚Üí 5.1 ‚Üí 4.5 ‚Üí 4.8  (varia√ß√£o: 0.9 cmolc/kg)
Altitude: 915 ‚Üí 935 ‚Üí 920 ‚Üí 928  (varia√ß√£o: 20 m)
         ‚Üí Condi√ß√µes SIMILARES ‚úÖ Use PCA/RDA

Gradiente LONGO (5.0 SD):
pH:       6.5 ‚Üí 5.5 ‚Üí 4.0         (varia√ß√£o: 2.5 unidades)
C√°lcio:   12.5 ‚Üí 5.2 ‚Üí 1.2        (varia√ß√£o: 11.3 cmolc/kg)
Altitude: 850 ‚Üí 950 ‚Üí 1100        (varia√ß√£o: 250 m)
         ‚Üí Condi√ß√µes MUITO DIFERENTES ‚ùå Use DCA/CCA/NMDS
```

## ‚ö†Ô∏è Limita√ß√£o Importante do PCA

**PCA funciona mal com dados de vegeta√ß√£o porque:**

-   Muitas esp√©cies ausentes = muitos zeros (50-80% da matriz)
-   Distribui√ß√µes assim√©tricas
-   Pressuposi√ß√£o de linearidade n√£o atendida

## PCA - Exemplo Visual Passo a Passo

```{r}
# Criar dados simples (6 parcelas x 2 esp√©cies)
raw <- matrix(c(1, 2, 2.5, 2.5, 1, 0.5, 0, 1, 2, 4, 3, 1), nrow = 6)
colnames(raw) <- c("s1", "s2")
rownames(raw) <- c("p1", "p2", "p3", "p4", "p5", "p6")
raw
```

Matriz de dados: 6 parcelas √ó 2 esp√©cies

## PASSO 1: Dados Originais

```{r}
#| fig-width: 8
#| fig-height: 6

plot(raw, type = "b", ylim = c(-2, 4), xlim = c(-2, 3))

```

## PASSO 2: Dados Padronizados

```{r}
#| fig-width: 8
#| fig-height: 6

# Dados brutos ‚Äúcentrados‚Äù (padronizados na mesma escala)
cent <- scale(raw, scale = T)
plot(raw, type = "b", ylim = c(-2, 4), xlim = c(-2, 3))
lines(cent, type = "b", pch = 20)
```

## PASSO 3: PCA (Eixos Rotacionados)

```{r}
#| fig-width: 8
#| fig-height: 6

# PCA - Rotacionar eixos
library(vegan)
o.pca <- prcomp(cent)
scores(o.pca)
plot(raw, type = "b", ylim = c(-2, 4), xlim = c(-2, 3))
lines(cent, type = "b", pch = 20)
lines(scores(o.pca), type = "b", pch = 5)
```

## PASSO 4: Biplot

```{r}
#| fig-width: 8
#| fig-height: 6
biplot(o.pca)

```

## PCA com Dados Reais - Solo da FOM

```{r}
# Carregar dados de solo
amb <- read.table("../data/environmental_data.csv", 
                  header = TRUE, sep = ";", dec = ",", 
                  row.names = 1)

# Ver as primeiras linhas
head(amb, 3)
```

## Executando PCA

```{r}
# Fazer PCA
pca_solo <- rda(amb, scale = TRUE)

# Quanto cada eixo explica?
summary(pca_solo)

```

## O que s√£o Autovalores? üî¢

**Autovalores** medem **quanto de varia√ß√£o** cada eixo captura dos dados.

## Executando PCA

-   Os loadings mostram a correla√ß√£o entre cada vari√°vel original e os componentes principais!

```{r}
# Loadings PCA
loadings <- scores(pca_solo, display = "species", choices = c(1, 2))
loadings
```

## Visualizar PCA - Solo

```{r}
#| fig-width: 10
#| fig-height: 7

# Gr√°fico (biplot)
biplot(pca_solo, 
       main = "PCA - Vari√°veis de Solo")
      
```

**Interpreta√ß√£o:** Setas vermelhas = vari√°veis de solo \| n√∫meros = parcelas

## Como Interpretar o Biplot?

-   **Setas longas** = vari√°vel importante

-   **Setas curtas** = vari√°vel pouco importante

-   **Setas no mesmo sentido** = correlacionadas (ex: Ca e Mg)

-   **Setas opostas** = correla√ß√£o negativa (ex: pH e Al)

-   **Parcelas pr√≥ximas** = solo parecido

-   **Parcelas distantes** = solo diferente

## NMDS - Para Dados de Vegeta√ß√£o

**Quando a PCA n√£o funciona bem...**

**Problemas com dados de vegeta√ß√£o:**

-   Muitas esp√©cies ausentes (zeros)
-   Distribui√ß√µes muito assim√©tricas
-   Gradientes muito longos

**Solu√ß√£o: NMDS (Non-metric Multidimensional Scaling)**

## NMDS - O Mais Flex√≠vel

**Non-metric Multidimensional Scaling**

**Vantagens:**

-   Funciona com qualquer tipo de dado
-   N√£o assume rela√ß√µes lineares
-   Muito usado em ecologia moderna
-   Robusto e confi√°vel

**Avalia√ß√£o: Stress (quanto menor, melhor)**

## NMDS na Pr√°tica

```{r}
# Fazer NMDS
# Carregar dados de vegeta√ß√£o
veg <- read.table("../data/vegetation_data.csv",
                  header = TRUE, sep = ";", dec = ",")

# Criar matriz: parcelas (linhas) x esp√©cies (colunas)
matriz <- as.data.frame.matrix(table(veg$PC, veg$Species))

# Criar vari√°vel de exposi√ß√£o
# 17 parcelas Norte + 33 parcelas Sul = 50 parcelas total
exposicao <- c(rep("Norte", 17), rep("Sul", 33))

nmds_result <- metaMDS(matriz,
                       k = 2,              # 2 dimens√µes
                       distance = "bray",  # √≠ndice de Bray-Curtis
                       trymax = 100)       # tentativas

# Avaliar qualidade
stress <- round(nmds_result$stress, 3)
```

**Stress: `r stress`**

```{r}
#| echo: false
if(stress < 0.05) {
  quality <- "**‚úì Excelente!** Representa√ß√£o perfeita"
} else if(stress < 0.10) {
  quality <- "**‚úì Muito bom!** Representa√ß√£o confi√°vel"
} else if(stress < 0.20) {
  quality <- "**‚ö† Aceit√°vel**, mas use com cuidado"
} else {
  quality <- "**‚úó Ruim**, n√£o usar!"
}
```

`r quality`

## Visualizar NMDS

```{r}
#| fig-width: 10
#| fig-height: 7


fig.nmds <- ordiplot(nmds_result, type = "none", font = 6, font.lab = 6, cex.axis = 1.2, 
    cex.lab = 1.2, xlim = c(-2, 1), ylim = c(-1.5, 1))
text(fig.nmds, "sites", col = "black", font = 6)
stems <- colSums(matriz)
sel <- orditorp(nmds_result, dis = "sp", priority = stems, pcol = "black", pch = "+", 
    cex = 0.7)
```

## Visualizar Stress plot

```{r}
#| fig-width: 10
#| fig-height: 7

stressplot(nmds_result)

```

## Testando Diferen√ßas Entre Grupos no PCA

**Pergunta: Os setores (Norte/Sul) diferem ao longo do gradiente ambiental?**

```{r}
# Extrair escores do PC1
eixosPCA <- scores(pca_solo, choices = 1:2, display = "sites")
PCA1 <- eixosPCA[,1]

# Verificar normalidade
shapiro.test(PCA1)
```

**Se p \> 0.05** ‚Üí dados normais ‚úì \| **Se p \< 0.05** ‚Üí usar teste n√£o-param√©trico

## Comparando Setores - Teste t

```{r}
# Teste t (exposicao j√° foi criada anteriormente)
t.test(PCA1 ~ exposicao)
```

**p \< 0.05?** ‚Üí Setores S√ÉO diferentes ambientalmente! ‚úì

## Visualizando Grupos no NMDS

```{r}
#| fig-width: 10
#| fig-height: 7

fig <- ordiplot(nmds_result, type = "none")

# Parcelas por grupo
points(fig, "sites", pch = 19, col = "blue", 
       select = exposicao == "Norte")
points(fig, "sites", pch = 1, col = "red", 
       select = exposicao == "Sul")

# Esp√©cies
sp.names <- make.cepnames(colnames(matriz))
stems <- colSums(matriz)
orditorp(nmds_result, "sp", label = sp.names,
         priority = stems, pch = "+", pcol = "grey")

legend("topleft", legend = c("Norte", "Sul"), 
       pch = c(19, 1), col = c("blue", "red"))
```

## Como o Ambiente Explica a Vegeta√ß√£o?

**Fun√ß√£o `envfit()` ajusta vari√°veis ambientais ao NMDS**

```{r}
# Ajustar vari√°veis ambientais √† ordena√ß√£o
env_fit <- envfit(nmds_result, amb, permutations = 999)
env_fit
```

**r¬≤** = for√ßa da correla√ß√£o \| **p \< 0.05** = vari√°vel significativa

## Visualizar NMDS + envfit

```{r}
#| fig-width: 10
#| fig-height: 7

fig <- ordiplot(nmds_result, type = "none")

# Parcelas por grupo
points(fig, "sites", pch = 19, col = "blue", 
       select = exposicao == "Norte")
points(fig, "sites", pch = 1, col = "red", 
       select = exposicao == "Sul")

# Esp√©cies
sp.names <- make.cepnames(colnames(matriz))
orditorp(nmds_result, "sp", label = sp.names,
         priority = colSums(matriz), pch = "+", 
         pcol = "grey", cex = 0.6)

# Vetores ambientais (p < 0.05)
plot(env_fit, p.max = 0.05, col = "darkgreen", 
     cex = 0.8, lwd = 2)

legend("topleft", legend = c("Norte", "Sul"), 
       pch = c(19, 1), col = c("blue", "red"))
```

## Interpretando o envfit

**Vetores ambientais:**

-   **Dire√ß√£o** ‚Üí gradiente da vari√°vel
-   **Comprimento** ‚Üí for√ßa da correla√ß√£o\
-   **√Çngulo** ‚Üí correla√ß√£o entre vari√°veis

**Exemplo:** - Parcelas **Norte** ‚Üí solos √°cidos, baixo Ca/Mg - Parcelas **Sul** ‚Üí solos f√©rteis, alto Ca/Mg - pH e Altitude explicam composi√ß√£o de esp√©cies

## NMDS Simplificado (sem esp√©cies)

```{r}
#| fig-width: 10
#| fig-height: 7

fig <- ordiplot(nmds_result, type = "none")

# Apenas parcelas
points(fig, "sites", pch = 19, col = "blue", 
       select = exposicao == "Norte")
points(fig, "sites", pch = 1, col = "red", 
       select = exposicao == "Sul")

# Apenas vetores significativos
plot(env_fit, p.max = 0.05, col = "darkgreen", 
     cex = 1, lwd = 2.5)

legend("topleft", legend = c("Norte", "Sul"), 
       pch = c(19, 1), col = c("blue", "red"))
```

Gr√°fico mais limpo para visualizar padr√µes ambientais! üìä

## PERMANOVA - Teste Multivariado

**Testa se composi√ß√£o de esp√©cies difere entre grupos**

```{r}
# PERMANOVA
permanova_result <- adonis2(matriz ~ exposicao, 
                            method = "bray",
                            permutations = 999)
permanova_result
```

**p \< 0.05?** ‚Üí Composi√ß√£o √â diferente entre Norte/Sul!

**R¬≤** ‚Üí % da varia√ß√£o explicada pela exposi√ß√£o

## Teste de Homogeneidade de Dispers√£o

**O que √© betadisper?**

Verifica se os grupos t√™m **dispers√£o** (variabilidade) semelhante

**Por que isso importa?**

-   PERMANOVA pode detectar diferen√ßas de dispers√£o OU de composi√ß√£o
-   Precisamos separar esses dois efeitos!

## An√°lise de Dispers√£o (betadisper)

```{r}
#| fig-width: 8
#| fig-height: 6

# Calcular dist√¢ncias de Bray-Curtis
dist_bray <- vegdist(matriz, method = "bray")

# Teste de dispers√£o entre grupos
dispersao <- betadisper(dist_bray, exposicao)

# Testar signific√¢ncia
anova(dispersao)

# Visualizar
plot(dispersao, main = "Dispers√£o Multivariada por Setor")
```

## Interpretando o betadisper

**Resultado do ANOVA:**

-   **p \> 0.05** ‚Üí Dispers√µes semelhantes ‚úÖ
    -   PERMANOVA confi√°vel!
    -   Diferen√ßa √© de composi√ß√£o
-   **p \< 0.05** ‚Üí Dispers√µes diferentes ‚ö†Ô∏è
    -   Aten√ß√£o! Grupos t√™m variabilidades distintas
    -   PERMANOVA pode estar detectando isso, n√£o composi√ß√£o

## Exemplo Visual - Dispers√µes Iguais

```{r}
#| echo: false
#| fig-width: 8
#| fig-height: 5

# Simular dados com mesma dispers√£o
set.seed(123)
grupo1 <- cbind(rnorm(20, 0, 1), rnorm(20, 0, 1))
grupo2 <- cbind(rnorm(20, 3, 1), rnorm(20, 3, 1))
dados_igual <- rbind(grupo1, grupo2)
grupos <- factor(rep(c("Norte", "Sul"), each = 20))

plot(dados_igual, col = c("blue", "red")[grupos], 
     pch = 19, cex = 1.2,
     main = "Dispers√µes IGUAIS (p > 0.05)",
     xlab = "NMDS1", ylab = "NMDS2")
legend("topright", legend = c("Norte", "Sul"), 
       col = c("blue", "red"), pch = 19)
```

Grupos separados, mas com variabilidade similar

## Exemplo Visual - Dispers√µes Diferentes

```{r}
#| echo: false
#| fig-width: 8
#| fig-height: 5

# Simular dados com dispers√µes diferentes
set.seed(123)
grupo1 <- cbind(rnorm(20, 0, 2.5), rnorm(20, 0, 2.5))  # mais disperso
grupo2 <- cbind(rnorm(20, 3, 0.5), rnorm(20, 3, 0.5))  # menos disperso
dados_dif <- rbind(grupo1, grupo2)

plot(dados_dif, col = c("blue", "red")[grupos], 
     pch = 19, cex = 1.2,
     main = "Dispers√µes DIFERENTES (p < 0.05)",
     xlab = "NMDS1", ylab = "NMDS2")
legend("topright", legend = c("Norte", "Sul"), 
       col = c("blue", "red"), pch = 19)
```

Norte muito vari√°vel, Sul homog√™neo ‚Üí problema!

## Resumo betadisper

**O que faz:** Testa se grupos t√™m variabilidade semelhante

**Quando usar:** Sempre DEPOIS do PERMANOVA significativo

**Interpreta√ß√£o conjunta:**

| PERMANOVA | betadisper | Conclus√£o               |
|-----------|------------|-------------------------|
| p \< 0.05 | p \> 0.05  | ‚úÖ Composi√ß√£o diferente |
| p \< 0.05 | p \< 0.05  | ‚ö†Ô∏è Dispers√£o diferente  |
| p \> 0.05 | qualquer   | Grupos n√£o diferem      |

## PCoA - An√°lise de Coordenadas Principais

**Principal Coordinates Analysis (PCoA)**

Tamb√©m conhecida como **MDS (Metric Multidimensional Scaling)**

**O que faz:** Representa rela√ß√µes entre parcelas usando qualquer √≠ndice de dissimilaridade

**Propriedade importante:** Transforma dissimilaridades em dist√¢ncias Euclidianas

## Como PCoA funciona?

**Entrada:** Matriz de dissimilaridades entre parcelas

**Sa√≠da:** Eixos ortogonais (independentes) ordenados por import√¢ncia

**Rela√ß√£o com outros m√©todos:**

-   PCoA com dist√¢ncia Euclidiana = PCA
-   PCoA com dist√¢ncia qui-quadrado ‚âà CA
-   PCoA com Bray-Curtis = ideal para vegeta√ß√£o

## PCoA na Pr√°tica

```{r}
# Calcular matriz de dissimilaridade
dist_bray <- vegdist(matriz, method = "bray")

# Executar PCoA
pcoa_result <- cmdscale(dist_bray, k = 2, eig = TRUE)

# Ver autovalores (% de varia√ß√£o)
eigenvalues <- pcoa_result$eig
var_explained <- eigenvalues / sum(eigenvalues) * 100

cat("Eixo 1:", round(var_explained[1], 1), "%\n")
cat("Eixo 2:", round(var_explained[2], 1), "%\n")
```

## ‚ö†Ô∏è Problema: Autovalores Negativos

**Quando usar √≠ndices n√£o-m√©tricos (ex: Bray-Curtis puro):**

-   Podem aparecer autovalores negativos
-   Eixos n√£o podem ser plotados!

**Solu√ß√µes:**

1.  Transformar para m√©trico: `sqrt()` no Bray-Curtis ‚úÖ
2.  Corre√ß√µes: Lingoes ou Cailliez
3.  Usar NMDS (aceita qualquer √≠ndice)

```{r}
# Bray-Curtis transformado (m√©trico)
dist_bray_sqrt <- sqrt(dist_bray)
pcoa_result <- cmdscale(dist_bray_sqrt, k = 2, eig = TRUE)
```

## Visualizar PCoA

```{r}
#| fig-width: 10
#| fig-height: 7

scores_pcoa <- pcoa_result$points

plot(scores_pcoa[,1], scores_pcoa[,2],
     xlab = paste0("PCoA1 (", round(var_explained[1], 1), "%)"),
     ylab = paste0("PCoA2 (", round(var_explained[2], 1), "%)"),
     main = "PCoA - Composi√ß√£o de Esp√©cies",
     pch = 19, 
     col = ifelse(exposicao == "Norte", "blue", "red"),
     cex = 1.5)

legend("topright", legend = c("Norte", "Sul"),
       col = c("blue", "red"), pch = 19)
```

## PCoA vs NMDS - Diferen√ßas Fundamentais

| Caracter√≠stica        | PCoA                   | NMDS                  |
|-----------------------|------------------------|-----------------------|
| **Algoritmo**         | Anal√≠tico (√∫nico)      | Iterativo (m√∫ltiplos) |
| **Usa valores**       | Dissimilaridades reais | Rankings              |
| **Reprodutibilidade** | Sempre igual           | Pode variar           |
| **N¬∫ de eixos**       | Dado pelos dados       | Voc√™ escolhe (k)      |
| **% explicada**       | Sim (autovalores)      | N√£o                   |
| **Qualidade**         | Autovalores            | Stress                |
| **Esp√©cies**          | Projetar depois        | Projetar depois       |

## Rela√ß√£o PCoA ‚Üí NMDS

**Conceito importante:**

NMDS geralmente usa PCoA como **configura√ß√£o inicial**

‚Üí NMDS otimiza a solu√ß√£o do PCoA iterativamente

‚Üí Tenta representar mais varia√ß√£o em menos eixos

**Na pr√°tica:** NMDS "melhora" o PCoA quando stress \< 0.20

## Quando usar cada um?

::::: columns
::: {.column width="50%"}
**Use PCoA quando:**

‚úì Precisar de % varia√ß√£o explicada

‚úì Quiser solu√ß√£o √∫nica/reprodut√≠vel

‚úì Dataset grande (\>100 parcelas)

‚úì An√°lise r√°pida

‚úì Comparar com PCA

‚úì Necessidade de eixos ortogonais
:::

::: {.column width="50%"}
**Use NMDS quando:**

‚úì Quiser melhor representa√ß√£o visual

‚úì √çndice n√£o-m√©trico (sem transformar)

‚úì Publicar figura principal

‚úì Stress \< 0.20

‚úì Dataset pequeno/m√©dio
:::
:::::

**Dica:** Rode os dois! NMDS otimiza PCoA quando funciona bem

## Compara√ß√£o Visual

```{r}
#| fig-width: 12
#| fig-height: 5

par(mfrow = c(1, 2))

# PCoA
plot(scores_pcoa[,1], scores_pcoa[,2],
     xlab = paste0("PCoA1 (", round(var_explained[1], 1), "%)"),
     ylab = paste0("PCoA2 (", round(var_explained[2], 1), "%)"),
     main = "PCoA - Solu√ß√£o Anal√≠tica",
     pch = 19, 
     col = ifelse(exposicao == "Norte", "blue", "red"))

# NMDS
plot(nmds_result, type = "n", main = paste0("NMDS - Stress = ", 
     round(nmds_result$stress, 3)))
points(nmds_result, display = "sites", pch = 19,
       col = ifelse(exposicao == "Norte", "blue", "red"))

par(mfrow = c(1, 1))
```

## Resumo: PCoA & NMDS

**PCoA:** - Solu√ß√£o anal√≠tica √∫nica e reprodut√≠vel - Fornece % varia√ß√£o explicada - R√°pido, ideal para grandes datasets - Prefira √≠ndices m√©tricos ou transforme

**NMDS:** - Solu√ß√£o iterativa (otimiza PCoA) - Avaliado por stress (\< 0.20) - Melhor representa√ß√£o visual - Aceita qualquer √≠ndice

**Ambos:** - Trabalham com matrizes de dissimilaridade - Esp√©cies adicionadas por weighted averaging - Use Bray-Curtis para dados de vegeta√ß√£o

## üîÑ Ordena√ß√µes Restritas

**N√£o-restritas:** Exploram padr√µes (PCA, NMDS)

**Restritas:** Testam hip√≥teses (RDA, CCA)

**Pergunta:** Ambiente explica a vegeta√ß√£o?

## DCA - Diagn√≥stico de Gradiente üéØ

**Objetivo:** Medir comprimento do gradiente

```{r}
# Executar DCA
dca_result <- decorana(matriz)

# Extrair comprimento (em SD)
cat("DCA1:", round(dca_result$evals[1], 2), "SD\n")
cat("DCA2:", round(dca_result$evals[2], 2), "SD\n")
```

**Regra:** \< 3 SD = **RDA** \| \> 4 SD = **CCA**

**üí° Execute DCA primeiro!**

## Escolhendo o M√©todo: Fluxograma üìä

```{r}
#| echo: false
#| fig-width: 9
#| fig-height: 6
library(DiagrammeR)

grViz("
digraph escolha {
  graph [rankdir = TB, bgcolor = transparent]
  node [shape = box, style = filled, fontname = Arial, fontsize = 11]

  START [label = 'Rode DCA primeiro!', fillcolor = '#FF6B6B', fontcolor = white]
  Q1 [label = 'Gradiente < 3 SD?', fillcolor = '#FFE66D', shape = diamond]
  Q2 [label = 'Tem vari√°veis\nexplicativas?', fillcolor = '#4ECDC4', shape = diamond]
  Q3 [label = 'Tem vari√°veis\nexplicativas?', fillcolor = '#4ECDC4', shape = diamond]

  PCA [label = 'PCA\n(n√£o-restrita)', fillcolor = '#95E1D3']
  RDA [label = 'RDA\n(restrita)', fillcolor = '#38A3A5']
  DCA [label = 'DCA/NMDS\n(n√£o-restrita)', fillcolor = '#95E1D3']
  CCA [label = 'CCA\n(restrita)', fillcolor = '#38A3A5']

  START -> Q1
  Q1 -> Q2 [label = 'Sim']
  Q1 -> Q3 [label = 'N√£o']
  Q2 -> PCA [label = 'N√£o']
  Q2 -> RDA [label = 'Sim']
  Q3 -> DCA [label = 'N√£o']
  Q3 -> CCA [label = 'Sim']
}
")
```

## RDA - An√°lise de Redund√¢ncia

**Quando:** Gradientes CURTOS (\< 3 SD)

**O que faz:**

-   **PCA ambiental:** descreve como as parcelas diferem no ambiente
-   **RDA:** testa se essas diferen√ßas ambientais explicam a vegeta√ß√£o

**Pergunta-chave:** As vari√°veis ambientais medidas explicam a composi√ß√£o de esp√©cies?

**Resultado:** R¬≤ = propor√ß√£o da varia√ß√£o da comunidade explicada pelo ambiente

## RDA na Pr√°tica

```{r}
# Verificar se gradiente √© curto (do DCA anterior)
# Se DCA1 < 3 SD ‚Üí usar RDA ‚úì

# Executar RDA
# Usar f√≥rmula com ~ . para incluir todas as vari√°veis
# Ou especificar vari√°veis espec√≠ficas
rda_result <- rda(matriz ~ ., data = amb)

# Ver resultados
rda_result

```

## Entendendo o Output do RDA

**Parti√ß√£o da In√©rcia:**

-   **Total** = Varia√ß√£o total nos dados
-   **Constrained** = Explicada pelas vari√°veis (IMPORTANTE!)
-   **Unconstrained** = N√£o explicada (res√≠duo)

**R¬≤ ajustado:** Propor√ß√£o da varia√ß√£o explicada (corrigido para n¬∫ de vari√°veis)

*Importante:* Use R¬≤ ajustado para comparar modelos com diferentes n√∫meros de vari√°veis

## Teste de Signific√¢ncia do RDA

```{r, eval=FALSE}
# Teste de permuta√ß√£o para o modelo completo
anova_rda <- anova.cca(rda_result, permutations = 999)
anova_rda

# Teste para cada vari√°vel
anova_rda_terms <- anova.cca(rda_result, by = "terms", permutations = 999)
anova_rda_terms

# Teste para cada eixo
anova_rda_axis <- anova.cca(rda_result, by = "axis", permutations = 999)
anova_rda_axis
```

**p \< 0.05?** ‚Üí Modelo/vari√°vel/eixo √â significativo!

## Interpretando os Testes de Permuta√ß√£o

**1. Modelo completo (anova.cca)** - Testa se as vari√°veis **em conjunto** explicam a vegeta√ß√£o - p \< 0.05 ‚Üí modelo significativo ‚úì

**2. Por vari√°vel (by = "terms")** - Testa cada vari√°vel **individualmente** - Identifica quais vari√°veis s√£o importantes - Use para **simplificar o modelo**

**3. Por eixo (by = "axis")** - Testa se cada eixo can√¥nico √© significativo - Quantos gradientes ambientais s√£o importantes? - Importante para decidir **quantos eixos interpretar**

## Interpretando o Triplot RDA

**3 Tipos de elementos:**

1.  **Parcelas (pontos)** ‚Üí composi√ß√£o flor√≠stica
2.  **Esp√©cies (texto)** ‚Üí ocorr√™ncia/abund√¢ncia
3.  **Setas verdes** ‚Üí gradientes ambientais

**Como interpretar:**

-   Parcelas pr√≥ximas = composi√ß√£o similar
-   Esp√©cie pr√≥xima da seta = favorecida pela vari√°vel
-   Seta longa = vari√°vel importante

## Visualizar RDA - Triplot

```{r}
#| fig-width: 12
#| fig-height: 9

# Criar gr√°fico base
plot(rda_result, type = "n",
     main = "RDA - Vegeta√ß√£o ~ Ambiente")

# Adicionar parcelas
points(rda_result, display = "sites", pch = 19,
       col = ifelse(exposicao == "Norte", "blue", "red"))

# Adicionar esp√©cies (principais)
sp.names <- make.cepnames(colnames(matriz))
text(rda_result, display = "species",
     labels = sp.names,
     cex = 0.6, col = "grey40")

# Adicionar vetores ambientais
text(rda_result, display = "bp",
     col = "darkgreen", cex = 0.9, lwd = 2)

legend("topright", legend = c("Norte", "Sul"),
       col = c("blue", "red"), pch = 19)
```

## Sele√ß√£o de Vari√°veis no RDA

**Problema:** Muitas vari√°veis podem causar overfitting

**Solu√ß√£o:** Sele√ß√£o forward

```{r, eval=FALSE}
# Modelo nulo (sem preditoras)
rda_null <- rda(matriz ~ 1, data = amb)

# Modelo completo (todas preditoras)
rda_full <- rda(matriz ~ ., data = amb)

# Sele√ß√£o forward
rda_select <- ordistep(rda_null,
                       scope = formula(rda_full),
                       direction = "forward",
                       permutations = 999)

# Ver vari√°veis selecionadas
rda_select$anova
```

## CCA - An√°lise de Correspond√™ncia Can√¥nica

**Canonical Correspondence Analysis - vers√£o restrita da CA**

**Quando usar:**

-   Gradientes LONGOS (\> 4 SD)
-   Dados de vegeta√ß√£o com muitos zeros
-   Vari√°veis ambientais como preditoras
-   Rela√ß√µes unimodais esp√©cie-ambiente

**Ideia b√°sica: CA que maximiza rela√ß√£o com vari√°veis ambientais**

## CCA vs RDA - Diferen√ßa Crucial

**Tipo de resposta das esp√©cies:**

-   **RDA:** Resposta LINEAR
    -   Esp√©cie aumenta continuamente com a vari√°vel
    -   Exemplo: umidade sempre favorece *Ilex paraguariensis*
-   **CCA:** Resposta UNIMODAL
    -   Esp√©cie tem √≥timo em valor intermedi√°rio
    -   Exemplo: *Araucaria angustifolia* prefere pH \~5.5

**Na pr√°tica:** CCA mais realista para gradientes longos!

## CCA na Pr√°tica

```{r}
# Verificar se gradiente √© longo (do DCA anterior)
# Se DCA1 > 4 SD ‚Üí usar CCA ‚úì

# Executar CCA
cca_result <- cca(matriz ~ ., data = amb)

# Ver resultados
cca_result
```

## Entendendo o Output do CCA

**In√©rcia:**

-   **Total** = Varia√ß√£o total (qui-quadrado)
-   **Constrained** = Explicada pelas vari√°veis
-   **Unconstrained** = N√£o explicada (res√≠duo)

**Diferen√ßa do RDA:** Usa dist√¢ncia qui-quadrado, n√£o Euclidiana

## Teste de Signific√¢ncia do CCA

```{r, eval=FALSE}
# Teste para o modelo completo
anova_cca <- anova.cca(cca_result, permutations = 999)
anova_cca

# Teste para cada vari√°vel
anova_cca_terms <- anova.cca(cca_result, by = "terms", permutations = 999)
anova_cca_terms

# Teste para cada eixo
anova_cca_axis <- anova.cca(cca_result, by = "axis", permutations = 999)
anova_cca_axis
```

## Interpretando o CCA

**Resposta unimodal das esp√©cies:**

-   Esp√©cie no centro = valor √≥timo intermedi√°rio
-   Esp√©cie na ponta = favorecida por valor extremo
-   Posi√ß√£o na seta = prefer√™ncia ambiental

## Visualizar CCA - Triplot

```{r}
#| fig-width: 12
#| fig-height: 9

# Criar gr√°fico
plot(cca_result, type = "n",
     main = "CCA - Vegeta√ß√£o ~ Ambiente (Gradiente Longo)")

# Parcelas
points(cca_result, display = "sites", pch = 19,
       col = ifelse(exposicao == "Norte", "blue", "red"))

# Esp√©cies (principais)
sp.names <- make.cepnames(colnames(matriz))
text(cca_result, display = "species",
     labels = sp.names,
     cex = 0.6, col = "grey40")

# Vetores ambientais
text(cca_result, display = "bp",
     col = "darkgreen", cex = 0.9, lwd = 2)

legend("topright", legend = c("Norte", "Sul"),
       col = c("blue", "red"), pch = 19)
```

## Sele√ß√£o de Vari√°veis no CCA

```{r, eval=FALSE}
# Modelo nulo
cca_null <- cca(matriz ~ 1, data = amb)

# Modelo completo
cca_full <- cca(matriz ~ ., data = amb)

# Sele√ß√£o forward
cca_select <- ordistep(cca_null,
                       scope = formula(cca_full),
                       direction = "forward",
                       permutations = 999)

# Ver vari√°veis selecionadas
cca_select$anova
```

## Compara√ß√£o: RDA vs CCA

| Caracter√≠stica | RDA             | CCA               |
|----------------|-----------------|-------------------|
| Gradiente      | Curto (\< 3 SD) | Longo (\> 4 SD)   |
| Resposta       | Linear          | Unimodal          |
| Dist√¢ncia      | Euclidiana      | Qui-quadrado      |
| Baseado em     | PCA             | CA                |
| Zeros          | Problema        | Tolerado          |
| Varia√ß√£o (%)   | R¬≤ ajustado     | In√©rcia explicada |

**Regra pr√°tica:** DCA primeiro ‚Üí se \< 3 SD use RDA, se \> 4 SD use CCA

## üß© Parti√ß√£o da Vari√¢ncia

**Pergunta central:** *Quanto cada grupo de vari√°veis explica da vegeta√ß√£o?*

**Situa√ß√£o comum:**

-   Dados de solo (pH, nutrientes)
-   Dados de topografia (altitude, declividade)
-   Dados espaciais (coordenadas)

**Objetivo:** Separar efeitos independentes de cada grupo!

## Por que Particionar?

**Problema:** Vari√°veis correlacionadas confundem interpreta√ß√£o

**Exemplo:**

-   Altitude correlacionada com temperatura
-   pH correlacionado com nutrientes
-   Ambos explicam vegeta√ß√£o ‚Üí mas quanto √© √∫nico de cada?

**Parti√ß√£o separa:**

-   Efeito **puro** de cada grupo
-   Efeito **compartilhado** entre grupos
-   Varia√ß√£o **n√£o explicada**

## Estrutura da Parti√ß√£o - 2 Grupos

```{r}
#| echo: false
#| fig-width: 8
#| fig-height: 5

library(DiagrammeR)

grViz("
digraph particao {
  graph [rankdir = LR, bgcolor = transparent]
  node [shape = box, style = filled, fontname = Arial, fontsize = 10]

  TOTAL [label = 'Varia√ß√£o TOTAL\n(100%)', fillcolor = '#E8E8E8']

  A [label = '[a] Solo puro', fillcolor = '#FFB84D']
  B [label = '[b] Compartilhado\nSolo + Topo', fillcolor = '#FF6B6B']
  C [label = '[c] Topografia pura', fillcolor = '#4ECDC4']
  D [label = '[d] N√£o explicado', fillcolor = '#95E1D3']

  TOTAL -> A
  TOTAL -> B
  TOTAL -> C
  TOTAL -> D
}
")
```

**\[a\]** = Efeito exclusivo do solo \| **\[b\]** = Efeito compartilhado \| **\[c\]** = Efeito exclusivo da topografia \| **\[d\]** = Outros fatores (dispers√£o, hist√≥rico, etc.)

## Parti√ß√£o na Pr√°tica - Setup

```{r}
# Preparar grupos de vari√°veis
# Verificar nomes das colunas dispon√≠veis
colnames(amb)

# Criar grupos de vari√°veis
solo <- amb[, c("ph", "P", "K", "Ca", "Mg", "MO")]
topo <- amb[, c("cotmedia", "desmax", "decmed")]

# Verificar
head(solo, 2)
head(topo, 2)

```

## Executar Parti√ß√£o com varpart()

```{r}
# Parti√ß√£o da vari√¢ncia
# Escolher RDA ou CCA baseado no DCA
# Aqui usamos RDA (assumindo gradiente curto)

part_result <- varpart(matriz, solo, topo)

# Ver resultados
part_result
```

## Interpretando varpart()

**Componentes da tabela:**

-   **X1 (Individual)** = Efeito puro do SOLO \[a\]
-   **X2 (Individual)** = Efeito puro da TOPOGRAFIA \[c\]
-   **X1+X2 (Shared)** = Efeito COMPARTILHADO \[b\]
-   **Residuals** = N√ÉO explicado \[d\]

**Valores negativos?** ‚Üí Artefato estat√≠stico, considerar como zero

## Visualizar Parti√ß√£o - Diagrama de Venn

```{r}
#| fig-width: 10
#| fig-height: 8

# Plotar diagrama de Venn
plot(part_result,
     digits = 2,
     bg = c("orange", "lightblue"),
     Xnames = c("Solo", "Topografia"),
     main = "Parti√ß√£o da Vari√¢ncia - Vegeta√ß√£o")
```

**Interpreta√ß√£o visual:** C√≠rculos = grupos de vari√°veis \| Sobreposi√ß√£o = efeito compartilhado \| Fora dos c√≠rculos = n√£o explicado

## Exemplo de Interpreta√ß√£o Ecol√≥gica

**Cen√°rio hipot√©tico dos nossos dados:**

-   **\[a\] Solo puro = 13.6%** ‚Üí Qu√≠mica do solo tem efeito independente
-   **\[b\] Compartilhado = 18.44%** ‚Üí Solo e altitude covariam
-   **\[c\] Topografia pura = 8%** ‚Üí Altitude tem efeito menor mas √∫nico
-   **\[d\] N√£o explicado = 81.56%** ‚Üí Outros fatores importantes!

**Conclus√£o:** Solo √© mais importante que topografia para explicar composi√ß√£o flor√≠stica

## Quando Usar Parti√ß√£o?

**‚úÖ Use quando:**

-   Tem m√∫ltiplos grupos de vari√°veis ambientais
-   Vari√°veis podem estar correlacionadas
-   Quer separar efeitos independentes
-   Precisa quantificar import√¢ncia relativa

**‚ö†Ô∏è Cuidados:**

-   Muitas vari√°veis ‚Üí overfitting
-   Selecione vari√°veis importantes antes (RDA/CCA com forward selection)
-   Valores negativos = considerar zero
-   Testar signific√¢ncia das fra√ß√µes

## Fluxo Completo de An√°lise

**Passo a passo recomendado:**

1.  **DCA** ‚Üí Verificar comprimento do gradiente
2.  **RDA ou CCA** ‚Üí Testar modelo completo
3.  **Forward selection** ‚Üí Selecionar vari√°veis importantes
4.  **Parti√ß√£o** ‚Üí Separar efeitos de grupos de vari√°veis
5.  **Interpretar** ‚Üí Conclus√µes ecol√≥gicas

## Resumo dos M√©todos

**Explora√ß√£o:**

-   **PCA** (curto): Padr√µes ambientais
-   **DCA** (longo): Diagn√≥stico, retorna SD
-   **NMDS**: Dissimilaridade (stress \< 0.2)

**Teste:**

-   **RDA** (curto): Ambiente explica vegeta√ß√£o? (R¬≤)
-   **CCA** (longo): Idem, para gradientes longos
-   **varpart**: Quanto cada grupo explica?

## Resumo Final: Escolha do M√©todo üéØ

**Fluxograma de decis√£o:**

1.  **Rode DCA primeiro!**
    -   \< 3 SD ‚Üí m√©todos lineares (PCA/RDA)
    -   \> 4 SD ‚Üí m√©todos unimodais (CA/CCA)
2.  **Tem vari√°veis explicativas?**
    -   N√ÉO ‚Üí ordena√ß√£o n√£o-restrita (PCA/DCA/NMDS)
    -   SIM ‚Üí ordena√ß√£o restrita (RDA/CCA)
3.  **M√∫ltiplos grupos de vari√°veis?**
    -   SIM ‚Üí Parti√ß√£o da vari√¢ncia

## Workflow Recomendado üìã

```{r}
#| echo: false
#| fig-width: 9
#| fig-height: 6.5

library(DiagrammeR)

grViz("
digraph workflow {
  graph [rankdir = TB, bgcolor = transparent]
  node [shape = box, style = filled, fontname = Arial, fontsize = 9]

  START [label = '1. Carregar dados\nveg + ambiente', fillcolor = '#E8E8E8']
  DCA [label = '2. DCA\nDiagn√≥stico gradiente', fillcolor = '#FFE66D']
  DECISAO [label = 'Gradiente < 3 SD?', fillcolor = '#FF6B6B', shape = diamond]

  CURTO1 [label = '3a. Explora√ß√£o\nPCA/NMDS', fillcolor = '#95E1D3']
  CURTO2 [label = '4a. Teste\nRDA + forward', fillcolor = '#4ECDC4']

  LONGO1 [label = '3b. Explora√ß√£o\nDCA/NMDS', fillcolor = '#95E1D3']
  LONGO2 [label = '4b. Teste\nCCA + forward', fillcolor = '#4ECDC4']

  PART [label = '5. Parti√ß√£o\nvarpart()', fillcolor = '#A8E6CF']
  INTER [label = '6. Interpreta√ß√£o\necol√≥gica', fillcolor = '#FFD3B6', shape = ellipse]

  START -> DCA
  DCA -> DECISAO
  DECISAO -> CURTO1 [label = 'Sim']
  DECISAO -> LONGO1 [label = 'N√£o']
  CURTO1 -> CURTO2
  LONGO1 -> LONGO2
  CURTO2 -> PART
  LONGO2 -> PART
  PART -> INTER
}
")
```


## Obrigado!

**Boas an√°lises!** üå≥üìä


**Contato:** Pedro Higuchi \| UDESC Lages-SC
